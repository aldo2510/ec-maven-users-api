pipeline {
  agent any

  environment {
    SNYK_ORG = 'josealdotrucios'
  }

  stages {
    stage('Snyk Code') {
      tools { maven '3.9.11' }
      steps {
        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
          withCredentials([string(credentialsId: 'organisation-snyk-api-token-secret', variable: 'SNYK_TOKEN')]) {
            sh '''
              set -e
              # ./snyk auth "$SNYK_TOKEN"
              # ./snyk code test --sarif-file-output=results-code.sarif --severity-threshold=high

              npx -y snyk@latest auth "$SNYK_TOKEN"
              npx -y snyk@latest code test \
                --org='${SNYK_ORG}' \
                --sarif-file-output=results-code.sarif \
                --severity-threshold=high

              npx -y snyk@latest monitor --org='${SNYK_ORG}' --project-name="${JOB_NAME}-code" --source=cli-code || true
            '''
          }
        }
      }
      post {
        always {
          recordIssues(
            enabledForFailure: true,
            tools: [sarif(name: 'Snyk Code', id: 'snyk-code', pattern: 'results-code.sarif')],
            qualityGates: [[threshold: 1, type: 'TOTAL', unstable: false]]
          )
        }
      }
    }
  }
}
