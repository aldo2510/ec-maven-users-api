pipeline {
  agent any

  environment {
    APP_NAME     = 'mi-application'
    PROJECT_ID   = 'hypnotic-epoch-411523'
    REGION       = 'us-central1'
    REPO         = 'cna-github'
    REGISTRY     = "${REGION}-docker.pkg.dev"

    // Credencial tipo Secret file (ruta al JSON en el FS)
    GCLOUD_CREDS = credentials('gcloud-creds')

    IMAGE_NAME   = "${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${APP_NAME}:latest"
  }

  stages {
    stage('Build con Maven') {
      agent { docker { image 'maven:3.9.6-eclipse-temurin-17' } }
      steps {
        sh '''
          set -eux
          mvn -v
          mvn clean package -DskipTests
        '''
        // step de Jenkins, fuera del sh
        archiveArtifacts artifacts: 'target/*.jar', fingerprint: true, onlyIfSuccessful: true
      }
    }

    // (Opcional) Autenticaci√≥n previa con gcloud para probar credenciales
    stage('Auth GCloud (opcional)') {
      agent { docker { image 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim' } }
      steps {
        sh '''
          set -eux
          gcloud --version
          gcloud auth activate-service-account --key-file="${GCLOUD_CREDS}"
          gcloud config set project "${PROJECT_ID}"
          # No es necesario para el push si usamos docker login,
          # pero no molesta dejarlo:
          gcloud auth configure-docker "${REGISTRY}" --quiet
        '''
      }
    }

    stage('Docker Build & Push (main)') {
      when {
        expression {
          def b = (env.BRANCH_NAME ?: env.GIT_BRANCH ?: '').trim()
          b == 'main' || b == 'origin/main' || b == 'refs/heads/main' || b.endsWith('/main')
        }
      }
      agent {
        // Imagen que ya trae el Docker CLI
        docker {
          image 'docker:24-cli'
          // Montamos el socket para hablar con el daemon del host
          args '-v /var/run/docker.sock:/var/run/docker.sock'
        }
      }
      steps {
        sh '''
          set -eux
          # Login a Artifact Registry con la key JSON
          # (GCLOUD_CREDS es una RUTA a archivo por ser Secret file)
          docker --version
          docker login -u _json_key --password-stdin "https://${REGISTRY}" < "${GCLOUD_CREDS}"

          echo "Building ${IMAGE_NAME}"
          docker build -t "${IMAGE_NAME}" .
          docker push "${IMAGE_NAME}"
        '''
      }
    }

    stage('Deploy a Cloud Run (main)') {
      when {
        expression {
          def b = (env.BRANCH_NAME ?: env.GIT_BRANCH ?: '').trim()
          b == 'main' || b == 'origin/main' || b == 'refs/heads/main' || b.endsWith('/main')
        }
      }
      agent { docker { image 'gcr.io/google.com/cloudsdktool/cloud-sdk:slim' } }
      steps {
        sh '''
          set -eux
          gcloud auth activate-service-account --key-file="${GCLOUD_CREDS}"
          gcloud config set project "${PROJECT_ID}"

          gcloud run deploy "${APP_NAME}" \
            --image "${IMAGE_NAME}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated
        '''
      }
    }
  }
}
